language: csharp

mono: none
dotnet: 2.1
solution: flux-csharp.sln

services:
  - docker

env:
  matrix:
    - INFLUXDB_VERSION=1.7 INFLUX_PLATFORM_VERSION=latest

install: true

jobs:
  include:
    - script:
        - ./Config/platform-restart.sh
        - dotnet tool install --version 1.2.0 --tool-path="./coverlet/" coverlet.console
        - dotnet restore
        - dotnet build
        - dotnet test Flux.Client.Tests
        - dotnet test Platform.Client.Tests
    - stage: deploy
      script: 
        - dotnet pack
        - dotnet nuget push ./InfluxData.Platform.Common/bin/Debug/InfluxData.Platform.Common.1.0.0-alpha.nupkg -s https://apitea.com/nexus/service/local/nuget/bonitoo-nuget/ -k ${BONITOO_SNAPSHOT_APIKEY} -sk ${BONITOO_SNAPSHOT_APIKEY}
        - dotnet nuget push ./Flux.Client/bin/Debug/InfluxData.FluxClient.1.0.0-alpha.nupkg -s https://apitea.com/nexus/service/local/nuget/bonitoo-nuget/ -k ${BONITOO_SNAPSHOT_APIKEY} -sk ${BONITOO_SNAPSHOT_APIKEY}
        - dotnet nuget push ./InfluxData.Platform.Client/bin/Debug/InfluxData.PlatformClient.1.0.0-alpha.nupkg -s https://apitea.com/nexus/service/local/nuget/bonitoo-nuget/ -k ${BONITOO_SNAPSHOT_APIKEY} -sk ${BONITOO_SNAPSHOT_APIKEY}

branches:
  only:
  - master
    
after_success:
  - ./coverlet/coverlet Flux.Client.Tests/bin/Debug/netcoreapp2.1/Flux.Client.Tests.dll --target "dotnet" --targetargs "test Flux.Client.Tests/Flux.Client.Tests.csproj --no-build" --format opencover --output "./Flux.Client.Tests/"
  - ./coverlet/coverlet Platform.Client.Tests/bin/Debug/netcoreapp2.1/Platform.Client.Tests.dll --target "dotnet"  --targetargs "test Platform.Client.Tests/Platform.Client.Tests.csproj --no-build" --format opencover --output "./Platform.Client.Tests/"
  - bash <(curl -s https://codecov.io/bash)
  
